## Creating your own Module

In this tutorial, we will walkthrough on how to create your own reusable functional module.
There are three ways to create functional modules:

1 - The dev tools home screen

2 - The terminal by running `npm run generate:module`

3 - Create them manually from scratch

To show you how functional modules work under the hood we will go with the this approach, in your text editor go under `/modules` and create a new folder call it `todo` you can call it whatever seems fit but we'll be making a todo module.
In your terminal change directories to `/todo` and initialize it

```bash
cd todo
npm init -y
```

## Bootstraps

The bootstraps folder executes all the files you put in it on server startup, suitable for app initialization.

Under `/todo` create another folder called `bootstraps` and under that create a file called `main.server.bootsrap.js`.
your folder structure so far should look something like this

```bash
modules
└── todo
    └── bootstraps
        └── main.server.bootstrap.js
```

> the file name is important it must follow this pattern `<file-name>.server.bootstrap.js` in order for them to be picked up

Open the `main.server.bootsrap.js` in your text editor and start by exporting a function like this

```javascript title=modules/todo/bootstraps/main.server.bootstrap.js lineNumbers=true
module.exports = (config, app, db) => {};
```

This function takes in three parameters

1 - the application's configuration

2 - the express app object

3 - and the database

For the purposes of this tutorial we're not going to go into the details and instead we're just going to log something to the console.

Remove the arguments because we're not going to use them and require in [debug](https://www.npmjs.com/package/debug) and call it inside the function with the string "Todo app Initialized"

```javascript title=modules/todo/bootstraps/main.server.bootstrap.js lineNumbers=true
const debug = require("debug")("modules:todo:bootstrap");

module.exports = () => {
  debug("Todo app Initialized");
};
```

Now to test out our app go to the terminal and running

```bash
npm start
```

You'll see the app's startup message on the console

![terminal messages](../../images/tutorial/todo_started.png)

Beautiful, our app works, next up we'll be looking at IAM

## IAM

[IAM](https://en.wikipedia.org/wiki/Identity_management) (Identity Access Management) plays the role of a wrapper around [express middlewares](https://expressjs.com/en/guide/using-middleware.html), IAM allows for a declarative way to make application routes, they also make it easy to make role-based privileges in your app.

In the `/todo` folder create a new folder called `iam`
and under `/iam` create a new file called `main.server.iam.js`

The folder structure so far should be looking like this:

```bash
modules
└── todo
    ├── bootstraps
    │   └── main.server.bootstrap.js
    └── iam
        └── main.server.iam.js
```

To declare a new route, you can use the provided snippet to automatically generate it, in your text editor on the `main.server.iam.js` if you're using [vscode](https://code.visualstudio.com/) text editor type `iam`
and then press `TAB`.

```javascript title=modules/todo/iam/main.server.iam.js lineNumbers=true
/**
 * @type { IAM.default }
 */
module.exports = {
  prefix: "/todo",
  routes: [
    {
      path: "/",
      methods: {
        get: {
          iam: "modules:todo:main:list",
          title: "List todo",
          groups: [],
          parents: ["modules:todo", "modules:todo:main"],
          description: "List available todo",
          middlewares: [],
        },
      },
    },
  ],
};
```

By default to call our API we must be logged in but to make it simple for this tutorial, all we need to do now is to make the API public by simply going to `/config/lib/acl.js` and add the iam string to the guest array like the following:

```javascript title=config/lib/acl.js lineNumbers=true
/**
 * Guest role
 * @type  {Array}
 */
const guest = ["vendor:users:public", "modules:todo:main"];

/**
 * User role
 * @type  {Array}
 */

const user = [
  /**
   * Users IAMs
   */
  "vendor:users:user",
  "vendor:users:auth",
];
/**
 * Admin role
 * @type  {Array}
 */
const admin = [
  ...user,
  /**
   * Admin IAMs
   */
  "vendor:users:admin",
  "vendor:users:roles",
];
/**
 * All roles
 */
module.exports = [
  {
    name: "guest",
    protected: true,
    title: "Guest role",
    description:
      "Role given for any unauthenticated user, or users who don't have any role.",
    iams: guest,
  },
  {
    name: "user",
    protected: true,
    iams: user,
    title: "User role",
    description: "The default role.",
  },
  {
    name: "admin",
    protected: true,
    iams: admin,
    title: "Admin role",
    description: "Given to advanced users.",
  },
];
```

```javascript title=modules/iam/main.server.iam.js lineNumbers=true
/**
 * @type { IAM.default }
 */
module.exports = {
  prefix: "/task",
  routes: [
    {
      path: "/",
      methods: {
        get: {
          iam: "",
          title: "",
          groups: [],
          parents: [],
          description: "",
          middlewares: [
            (req, res) => {
              res.json({ message: "hello world" });
            },
          ],
        },
      },
    },
  ],
};
```

next up we're going to make our second route which is going to be a `POST` request

```javascript title=modules/iam/main.server.iam.js lineNumbers=true
/**
 * @type { IAM.default }
 */
module.exports = {
  prefix: "/task",
  routes: [
    {
      path: "/",
      methods: {
        get: {
          iam: "",
          title: "",
          groups: [],
          parents: [],
          description: "",
          middlewares: [(req, res) => res.json({ message: "hello world" })],
        },
      },
    },
    {
      path: "/",
      methods: {
        post: {
          iam: "",
          title: "",
          groups: [],
          parents: [],
          description: "",
          middlewares: [(req, res) => res.json({ message: "hello world" })],
        },
      },
    },
  ],
};
```

## Controllers

Up next we're going to make a controllers folder to handle the business logic for our routes separately, same as `bootstraps` and `iam` create a new folder under `/todo` and name it `controllers` and under controllers create a file called `main.server.controller.js`

```bash
modules
└── todo
    ├── bootstraps
    │   └── main.server.bootstrap.js
    ├── iam
    │   └── main.server.iam.js
    └── controllers
        └── main.server.controller.js
```

And to create a new controller, you could use the built-in snippet.
Type `ctrl` and press `TAB` and it'll generate the controller's base code and [JSDoc](https://devdocs.io/jsdoc/) for you

```javascript title=modules/todo/controllers/main.server.iam.js lineNumbers=true
/**
*
* @controller List
* @param  {Express.Request}  req The request
* @param  {OutcommingMessage}  res The response
* @param  {Function}  next Go to the next middleware
*/

exports.  =  async  function (req, res, next) {

};
```

we will create two controllers for the `list` and `create` todo

```javascript title=modules/todo/controllers/main.server.iam.js lineNumbers=true
/**
 * List todo
 * @controller List
 * @param  {Express.Request}  req The request
 * @param  {OutcommingMessage}  res The response
 * @param  {Function}  next Go to the next middleware
 */

exports.list = async function list(req, res, next) {
  res.json({ message: "hello world" });
};

/**
 * Create Task
 * @controller Create
 * @param  {Express.Request}  req The request
 * @param  {OutcommingMessage}  res The response
 * @param  {Function}  next Go to the next middleware
 */

exports.create = async function create(req, res, next) {
  res.json({ message: "hello world" });
};
```

now let's get back to our `modules/todo/iam/main.server.iam.js` file and require in our controllers on the top

```javascript title=modules/todo/iam/main.server.iam.js lineNumbers=true
const ctrls = require("../controllers/main.server.controller");

/**
 * @type { IAM.default }
 */
module.exports = {
  prefix: "/task",
  routes: [
    {
      path: "/",
      methods: {
        get: {
          iam: "modules:todo:main:list",
          title: "List todo",
          groups: [],
          parents: ["modules:todo", "modules:todo:main"],
          description: "List available todo",
          middlewares: [crtls.list],
        },
        {
        post: {
          iam: "modules:todo:main:create",
          title: "Create new task",
          groups: [],
          parents: ["modules:todo", "modules:todo:main"],
          description: "Create new task",
          middlewares: [crtls.create],
        },
      }
      },
    }, {
    path: '/:taskId',
    methods: {
      get: {
        iam: 'modules:todo:main:one:get',
        title: 'Get task',
        groups: [],
        parents: ['modules:todo', 'modules:todo:main'],
        description: 'Get specific task',
        middlewares: [
          ctrls.one,
        ],
      },
      put: {
        iam: 'modules:todo:main:one:get',
        title: 'Update task',
        groups: [],
        parents: ['modules:todo', 'modules:todo:main'],
        description: 'Modify task',
        middlewares: [
          ctrls.update,
        ],
      },
      delete: {
        iam: 'modules:todo:main:one:remove',
        title: 'Remove task',
        groups: [],
        parents: ['modules:todo', 'modules:todo:main'],
        description: 'Remove an existing task',
        middlewares: [
          ctrls.remove,
        ],
      },
    },
  }
  ],
};
```

And now our next step is to create a model for our todo

## Models

to make a new model we need to create a new folder under the `/todo` folder called `models`, where all of our schemas will live and under `models` create a file called `task.server.model.js`

```bash
modules
└── todo
    ├── bootstraps
    │   └── main.server.bootstrap.js
    ├── iam
    │   └── main.server.iam.js
    ├── controllers
    │   └── main.server.controller.js
    └── models
        └── task.server.model.js
```

To generate a new model there's a snippet for that, in `modules/todo/models/task.server.model.js` type in `module:model` and then press `TAB`

```javascript title=modules/models/task.server.model.js lineNumbers=true
/**
 * Module dependencies.
 */
const { Schema, model } = require("mongoose");
const { timestamps } = require("@config/index").lib.mongoose;

const TodoSchema = new Schema(
  {
    name: String,
    done: {
      type: Boolean,
      default: false,
    },
  },
  {
    timestamps,
  }
);

module.exports = model("Todo", TodoSchema);
```

Now let's use our newly created model in the controller, on the top of the file require in the model from [mongoose](https://mongoosejs.com/) and do the logic for listing our todo and creating a task

```javascript title=modules/todo/controllers/main.server.controller.js lineNumbers=true
const { model } = require("mongoose");
const Todo = model("Todo");

/**
 * List tasls
 * @controller List
 * @param {Express.Request} req The request
 * @param {OutcommingMessage} res The response
 * @param {Function} next Go to the next middleware
 */
exports.list = async function list(req, res, next) {
  try {
    const result = await Todo.find();
    return res.json(result);
  } catch (e) {
    return next(e);
  }
};

/**
 * Create new task
 * @controller Create
 * @param {Express.Request} req The request
 * @param {OutcommingMessage} res The response
 * @param {Function} next Go to the next middleware
 */
exports.create = async function create(req, res, next) {
  const { body } = req;
  let task = new Todo(body);

  try {
    task = await task.save({ new: true });
  } catch (e) {
    return next(e);
  }

  return res.status(201).json(task);
};
```
